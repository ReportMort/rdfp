<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulling Reports with rdfp • rdfp</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Pulling Reports with rdfp">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98603021-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-98603021-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rdfp</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/administrative-tasks.html">Administrative Tasks</a>
    </li>
    <li>
      <a href="../articles/ad-trafficking-setup.html">Ad Trafficking Setup</a>
    </li>
    <li>
      <a href="../articles/manipulating-orders-and-lineitems.html">Manipulating Orders and LineItems</a>
    </li>
    <li>
      <a href="../articles/checking-availability.html">Checking Availability</a>
    </li>
    <li>
      <a href="../articles/pulling-reports.html">Pulling Reports</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/StevenMMortimer/rdfp">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Pulling Reports with rdfp</h1>
                        <h4 class="author">Steven M. Mortimer</h4>
            
            <h4 class="date">2018-03-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/StevenMMortimer/rdfp/blob/master/vignettes/pulling-reports.Rmd"><code>vignettes/pulling-reports.Rmd</code></a></small>
      <div class="hidden name"><code>pulling-reports.Rmd</code></div>

    </div>

    
    
<p>First, we load <strong>rdfp</strong> and specify the DFP network we would like to connect to. Then we authenticate by using <code><a href="../reference/dfp_auth.html">dfp_auth()</a></code>. Any existing cached token would be used or we will be prompted to authenticate via the browser.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rdfp)
<span class="kw">options</span>(<span class="dt">rdfp.network_code =</span> <span class="dv">123456789</span>)
<span class="kw"><a href="../reference/dfp_auth.html">dfp_auth</a></span>()</code></pre></div>
<div id="delivery-by-advertiser" class="section level4">
<h4 class="hasAnchor">
<a href="#delivery-by-advertiser" class="anchor"></a>Delivery by Advertiser</h4>
<p>A common report request is to check how each line item is delivering for an advertiser. This type of request can be run through a DFP report job. Report jobs have a special flow, but there is a single function, <code><a href="../reference/dfp_full_report_wrapper.html">dfp_full_report_wrapper()</a></code>, in the <strong>rdfp</strong> package that will manage that entire flow and run a requested job for you.</p>
<p>In this example, we specify dimensions including the line, order, advertiser, and ad unit. The <code>'FLAT'</code> ad unit view just ensures that we get tabular data with one row per ad unit in case we’d like to total them up. If you’d like to run multiple reports with slight variations in date or dimensions, it is encouraged that you keep you criteria and use a loop or vectorized function to generate each report since the request data must be formatted as a list in each call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reportJob =</span>
                        <span class="kw">list</span>(<span class="dt">reportQuery =</span>
                               <span class="kw">list</span>(<span class="dt">dimensions =</span> <span class="st">'MONTH_AND_YEAR'</span>,
                                    <span class="dt">dimensions =</span> <span class="st">'AD_UNIT_ID'</span>,
                                    <span class="dt">dimensions =</span> <span class="st">'AD_UNIT_NAME'</span>,
                                    <span class="dt">dimensions =</span> <span class="st">'ADVERTISER_NAME'</span>,
                                    <span class="dt">dimensions =</span> <span class="st">'ORDER_NAME'</span>,
                                    <span class="dt">dimensions =</span> <span class="st">'LINE_ITEM_NAME'</span>,
                                    <span class="dt">adUnitView =</span> <span class="st">'FLAT'</span>,
                                    <span class="dt">columns =</span> <span class="st">'AD_SERVER_IMPRESSIONS'</span>, 
                                    <span class="dt">columns =</span> <span class="st">'AD_SERVER_CLICKS'</span>,
                                    <span class="dt">dateRangeType =</span> <span class="st">'LAST_WEEK'</span>)
                             )
                      )
report_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_full_report_wrapper.html">dfp_full_report_wrapper</a></span>(request_data)
report_data[,<span class="kw">c</span>(<span class="st">'Dimension.MONTH_AND_YEAR'</span>, <span class="st">'Dimension.AD_UNIT_ID'</span>, <span class="st">'Column.AD_SERVER_CLICKS'</span>)]
<span class="co">#&gt; # A tibble: 7,040 x 3</span>
<span class="co">#&gt;    Dimension.MONTH_AND_YEAR Dimension.AD_UNIT_ID Column.AD_SERVER_CLICKS</span>
<span class="co">#&gt;    &lt;chr&gt;                                   &lt;dbl&gt;                   &lt;dbl&gt;</span>
<span class="co">#&gt;  1 2018-12                           21677451947                       1</span>
<span class="co">#&gt;  2 2018-12                           21677451947                      23</span>
<span class="co">#&gt;  3 2018-12                           21677451947                       9</span>
<span class="co">#&gt;  4 2018-12                           21677451947                     150</span>
<span class="co">#&gt;  5 2018-12                           21677451947                       0</span>
<span class="co">#&gt;  6 2018-12                           21677451947                      41</span>
<span class="co">#&gt;  7 2018-12                           21677451947                      73</span>
<span class="co">#&gt;  8 2018-12                           21677451947                      37</span>
<span class="co">#&gt;  9 2018-12                           21677451947                      23</span>
<span class="co">#&gt; 10 2018-12                           21677451947                      32</span>
<span class="co">#&gt; # ... with 7,030 more rows</span></code></pre></div>
</div>
<div id="working-with-saved-queries" class="section level4">
<h4 class="hasAnchor">
<a href="#working-with-saved-queries" class="anchor"></a>Working with Saved Queries</h4>
<p>DFP has a feature that allows for saving query criteria. These queries can be pulled back via the API and the criteria submitted back so that you always run the same report each time, or can easily replicate a query that another person has created in the UI.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># look for a particular saved query</span>
request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">filterStatement=</span><span class="kw">list</span>(<span class="dt">query=</span><span class="st">"WHERE id = 936165016"</span>))
this_result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_getSavedQueriesByStatement.html">dfp_getSavedQueriesByStatement</a></span>(request_data, <span class="dt">as_df=</span><span class="ot">FALSE</span>)
this_report_query &lt;-<span class="st"> </span>this_result[[<span class="dv">1</span>]]<span class="op">$</span>reportQuery

<span class="co"># resubmit the report job with the saved query</span>
report_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reportJob=</span><span class="kw">list</span>(<span class="dt">reportQuery =</span> this_report_query))
report_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_full_report_wrapper.html">dfp_full_report_wrapper</a></span>(report_data)
report_data[,<span class="kw">c</span>(<span class="st">'Dimension.AD_UNIT_ID'</span>, <span class="st">'Column.AD_SERVER_CLICKS'</span>)]
<span class="co">#&gt; # A tibble: 7,228 x 2</span>
<span class="co">#&gt;    Dimension.AD_UNIT_ID Column.AD_SERVER_CLICKS</span>
<span class="co">#&gt;                   &lt;dbl&gt;                   &lt;dbl&gt;</span>
<span class="co">#&gt;  1          21677451947                       9</span>
<span class="co">#&gt;  2          21677451947                     204</span>
<span class="co">#&gt;  3          21677451947                      19</span>
<span class="co">#&gt;  4          21677451947                     668</span>
<span class="co">#&gt;  5          21677451947                       2</span>
<span class="co">#&gt;  6          21677451947                     112</span>
<span class="co">#&gt;  7          21677451947                     182</span>
<span class="co">#&gt;  8          21677451947                      75</span>
<span class="co">#&gt;  9          21677451947                     211</span>
<span class="co">#&gt; 10          21677451947                     222</span>
<span class="co">#&gt; # ... with 7,218 more rows</span></code></pre></div>
</div>
<div id="a-more-detailed-explanation-of-the-report-process" class="section level4">
<h4 class="hasAnchor">
<a href="#a-more-detailed-explanation-of-the-report-process" class="anchor"></a>A More Detailed Explanation of the Report Process</h4>
<p>Reports actually require 3 steps from the [ReportService] (<a href="https://developers.google.com/ad-manager/api/reference/v201811/ReportService" class="uri">https://developers.google.com/ad-manager/api/reference/v201811/ReportService</a>): 1) to request the report, 2) check on its status, and 3) download. This basic process flow is required for all reports requested via this service. The wrapper function used above named <code>dfp_full_report_wrapper</code> manages all aspects of reporting, so this level of detail is not needed unless the wrapper service does not quite fit your needs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># In order to run a report you must specify how the report should be structured </span>
<span class="co"># by specifying a reportQuery inside a reportJob. All of the dimensions, columns, </span>
<span class="co"># date range options, etc. are documented at:</span>
<span class="co"># https://developers.google.com/ad-manager/api/reference/v201811/ReportService.ReportQuery</span>
request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reportJob=</span><span class="kw">list</span>(<span class="dt">reportQuery=</span><span class="kw">list</span>(<span class="dt">dimensions=</span><span class="st">'MONTH_AND_YEAR'</span>, 
                                                     <span class="dt">dimensions=</span><span class="st">'AD_UNIT_ID'</span>,
                                                     <span class="dt">adUnitView=</span><span class="st">'FLAT'</span>,
                                                     <span class="dt">columns=</span><span class="st">'AD_SERVER_CLICKS'</span>, 
                                                     <span class="dt">dateRangeType=</span><span class="st">'LAST_WEEK'</span>
                                                     )))

<span class="co"># the result is a list and most importantly the ID is included for checking its status</span>
dfp_runReportJob_result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_runReportJob.html">dfp_runReportJob</a></span>(request_data)
dfp_runReportJob_result<span class="op">$</span>id
<span class="co">#&gt; [1] 11076446453</span>

<span class="co"># to check the status repeatedly you just need to provide the id</span>
<span class="co"># dfp_getReportJobStatus_result returns a character string of the reportJob status</span>
request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reportJobId=</span>dfp_runReportJob_result<span class="op">$</span>id)
dfp_getReportJobStatus_result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_getReportJobStatus.html">dfp_getReportJobStatus</a></span>(request_data)
dfp_getReportJobStatus_result
<span class="co">#&gt; # A tibble: 1 x 1</span>
<span class="co">#&gt;   V1         </span>
<span class="co">#&gt;   &lt;chr&gt;      </span>
<span class="co">#&gt; 1 IN_PROGRESS</span>

<span class="co"># a simple while loop can keep checking a long running request until ready</span>
counter &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="cf">while</span>(dfp_getReportJobStatus_result<span class="op">$</span>V1 <span class="op">!=</span><span class="st"> 'COMPLETED'</span> <span class="op">&amp;</span><span class="st"> </span>counter <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>){
  dfp_getReportJobStatus_result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_getReportJobStatus.html">dfp_getReportJobStatus</a></span>(request_data)
  <span class="kw">Sys.sleep</span>(<span class="dv">3</span>)
  counter &lt;-<span class="st"> </span>counter <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
}

<span class="co"># once the status is "COMPLETED" the data download URL can be retrieved</span>
request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reportJobId=</span>dfp_runReportJob_result<span class="op">$</span>id, <span class="dt">exportFormat=</span><span class="st">'CSV_DUMP'</span>)
dfp_getReportDownloadURL_result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_getReportDownloadURL.html">dfp_getReportDownloadURL</a></span>(request_data)

<span class="co"># this function has been provided to download the data from URL and convert to a tbl_df</span>
<span class="co"># supported exportFormats are currently c('CSV_DUMP', 'TSV', 'TSV_EXCEL')</span>
report_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dfp_report_url_to_dataframe.html">dfp_report_url_to_dataframe</a></span>(<span class="dt">report_url=</span>dfp_getReportDownloadURL_result<span class="op">$</span>V1, 
                                           <span class="dt">exportFormat=</span><span class="st">'CSV_DUMP'</span>)
report_data[,<span class="kw">c</span>(<span class="st">'Dimension.MONTH_AND_YEAR'</span>, <span class="st">'Dimension.AD_UNIT_ID'</span>, <span class="st">'Column.AD_SERVER_CLICKS'</span>)]
<span class="co">#&gt; # A tibble: 9 x 3</span>
<span class="co">#&gt;   Dimension.MONTH_AND_YEAR Dimension.AD_UNIT_ID Column.AD_SERVER_CLICKS</span>
<span class="co">#&gt;   &lt;chr&gt;                                   &lt;dbl&gt;                   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2018-12                           21677451947                     864</span>
<span class="co">#&gt; 2 2018-12                           21677451950                     210</span>
<span class="co">#&gt; 3 2018-12                           21677553898                    5049</span>
<span class="co">#&gt; 4 2018-12                           21677553901                     174</span>
<span class="co">#&gt; 5 2018-12                           21677553904                    3474</span>
<span class="co">#&gt; 6 2018-12                           21677451953                    1687</span>
<span class="co">#&gt; 7 2018-12                           21677553910                      65</span>
<span class="co">#&gt; 8 2018-12                           21677553913                    2589</span>
<span class="co">#&gt; 9 2018-12                           21677554012                      75</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Steven M. Mortimer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script>
  docsearch({
    
    
    apiKey: '8ecf941477ebecebe34b5825a4ae705e',
    indexName: 'rdfp',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
